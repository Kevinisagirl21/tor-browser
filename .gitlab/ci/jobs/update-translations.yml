.update-translation-base:
  stage: update-translations
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push")
      changes:
        - "**/*.ftl"
        - "**/*.properties"
        - "**/*.dtd"
        - "**/*strings.xml"
        - "**/update-translations.yml"
        - "**/l10n/combine/combine.py"
        - "**/l10n/combine-translation-versions.py"
    - if: $FORCE_UPDATE_TRANSLATIONS == "true"
  variables:
    TOR_BROWSER_COMBINED_FILES_JSON: "combined-translation-files.json"


combine-en-US-translations:
  extends: .update-translation-base
  image: python
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    TRANSLATION_FILES: '[
      {
        "name": "brand.ftl",
        "where": ["browser/branding/tb-release", "toolkit/torbutton"],
        "branch": "tor-browser",
        "directory": "branding"
      },
      {
        "name": "brand.properties",
        "where": ["browser/branding/tb-release", "toolkit/torbutton"],
        "branch": "tor-browser"
      },
      { "name": "tor-browser.ftl", "branch": "tor-browser" },
      { "name": "aboutTBUpdate.dtd", "branch": "tor-browser" },
      { "name": "torbutton.dtd", "branch": "tor-browser" },
      { "name": "onionLocation.properties", "branch": "tor-browser" },
      { "name": "settings.properties", "branch": "tor-browser" },
      { "name": "torbutton.properties", "branch": "tor-browser" },
      { "name": "torConnect.properties", "branch": "tor-browser" },
      { "name": "torlauncher.properties", "branch": "tor-browser" },
      { "name": "base-browser.ftl", "branch": "base-browser" },
      {
        "name": "torbrowser_strings.xml",
        "branch": "fenix-torbrowserstringsxml",
        "exclude-legacy": true
      }
    ]'
    TRANSLATION_INCLUDE_LEGACY: "true"
  cache:
    paths:
      - .cache/pip
  # Artifact is for translation project job
  artifacts:
    paths:
      - "$TOR_BROWSER_COMBINED_FILES_JSON"
    expire_in: "60 min"
    reports:
      dotenv: job_id.env
  # Don't load artifacts for this job.
  dependencies: []
  script:
    # Save this CI_JOB_ID to the dotenv file to be used in the variables for the
    # push-en-US-translations job.
    - echo 'COMBINE_TRANSLATIONS_JOB_ID='"$CI_JOB_ID" >job_id.env
    - pip install compare_locales
    - python ./tools/torbrowser/l10n/combine-translation-versions.py "$CI_COMMIT_BRANCH" "$TRANSLATION_FILES" "$TOR_BROWSER_COMBINED_FILES_JSON"

push-en-US-translations:
  extends: .update-translation-base
  needs:
    - job: combine-en-US-translations
  variables:
    TOR_BROWSER_COMBINED_FILES_JSON_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/jobs/${COMBINE_TRANSLATIONS_JOB_ID}/artifacts/${TOR_BROWSER_COMBINED_FILES_JSON}"
  trigger:
    strategy: depend
    project: tor-browser-translation-bot/translation
    branch: tor-browser-ci
